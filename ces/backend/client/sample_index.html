<!DOCTYPE html>
<html>
<head>
  <title>Health and Wellbeing App</title>
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  
  <!-- Favicon -->
  <!-- <link rel="icon" type="image/x-icon" href="assets/favicon.ico"> -->
  <link rel="icon" type="image/x-icon" href="assets/google-gemini-icon.ico">
</head>
<body>
  <div class="header-section">
    <img src="assets/gemini_logo.png" alt="Gemini Multimodal Live" class="logo-image">
    <!-- <h1>Healthcare anytime, anywhere</h1> -->
    <p>Speak into your microphone and optionally share your webcam or screen to engage in a multimedia conversation.</p>
  </div>

  <div class="input-container">
    <button id="micButton" disabled class="action-button">
      <span class="material-symbols-outlined">mic</span>
    </button>
    <!-- <select id="cameraSelect"></select> -->
    <div class="camera-selector">
      <button id="cameraIconButton" class="action-button">
        <span class="material-symbols-outlined">cameraswitch</span>
      </button>
      <div id="cameraDropdown" class="camera-dropdown hidden">
        <select id="cameraSelect">
        </select>
      </div>
      <button id="webcamButton" class="action-button">
        <span class="material-symbols-outlined">videocam</span>
      </button>
    </div>
    <button id="screenButton" class="action-button">
      <span class="material-symbols-outlined">present_to_all</span>
    </button>
    <div class="text-input-container">
      <input type="text" id="textInput" placeholder="Type your message..." class="text-input">
      <button id="sendButton" class="action-button">
        <span class="material-symbols-outlined">send</span>
      </button>
      <button id="interruptButton" class="action-button" style="display: none;">
        <span class="material-symbols-outlined">cancel</span>
      </button>
          </div>
  </div>

  <div class="video-container">
    <video id="videoPreview" autoplay playsinline class="hidden"></video>
  </div>

  <div id="output"></div>

  <!-- Load EventEmitter3 first -->
  <script src="https://cdn.jsdelivr.net/npm/eventemitter3@5.0.1/dist/eventemitter3.umd.min.js"></script>

  <script type="module">
    import { AudioRecorder } from './src/audio/audio-recorder.js';
    import { AudioStreamer } from './src/audio/audio-streamer.js';
    import { MediaHandler } from './src/media/media-handler.js';
    import { GeminiAPI } from './src/api/gemini-api.js';
    import { base64ToArrayBuffer } from './src/utils/utils.js';

    // Initialize components
    const output = document.getElementById('output');
    const audioRecorder = new AudioRecorder();
    const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
    const audioStreamer = new AudioStreamer(audioContext);
    const mediaHandler = new MediaHandler();
    const api = new GeminiAPI('ws://localhost:8081'); //Local dev only
    // const api = new GeminiAPI('wss://google-liveapi-backend-tm5jum3toa-uc.a.run.app');

    const cameraSelect = document.getElementById('cameraSelect');
    const cameraIconButton = document.getElementById('cameraIconButton');
    const cameraDropdown = document.getElementById('cameraDropdown');

    let isRecording = false;
    let hasShownSpeakingMessage = false;
    let currentTurn = 0;
    let lastAudioTurn = -1;
    let geminiMessageElement = null; // To hold the streaming message element

    // Initialize media handler
    mediaHandler.initialize(document.getElementById('videoPreview'));

    // Set up API handlers
    api.onReady = () => {
      document.getElementById('micButton').disabled = false;
    };

    api.onAudioData = async (audioData) => {
      try {
        if (!api.isSpeaking || lastAudioTurn !== currentTurn) {
          // logMessage('Gemini: Speaking...');
          api.isSpeaking = true;
          lastAudioTurn = currentTurn;
          document.getElementById('interruptButton').style.display = 'inline-block';
        }
        const arrayBuffer = base64ToArrayBuffer(audioData);
        audioStreamer.addPCM16(new Uint8Array(arrayBuffer));
        audioStreamer.resume();
      } catch (error) {
        console.error('Error playing audio:', error);
      }
    };

    // api.onTextContent = (text) => {
    //   if (text.trim()) {
    //     logMessage('Gemini: ' + text);
    //   }
    // };

    api.onTextContent = (text) => {
      if (text.trim() || geminiMessageElement) {
        if (!geminiMessageElement) {
          geminiMessageElement = document.createElement('p');
          geminiMessageElement.className = 'gemini-message';
          geminiMessageElement.textContent = 'Gemini: ';
          output.appendChild(geminiMessageElement);
        }
        geminiMessageElement.textContent += text;
        output.scrollTop = output.scrollHeight;
      }
    };

    api.onTurnComplete = () => {
      // logMessage('Gemini: Finished speaking');
      api.isSpeaking = false;  // Reset speaking state
      audioStreamer.complete();
      document.getElementById('interruptButton').style.display = 'none';
      geminiMessageElement = null;
    };

    // Add interruption handler
    api.onInterrupted = (data) => {
      logMessage('Gemini: Response interrupted');
      api.isSpeaking = false;
      audioStreamer.stop();  // Stop current playback and clear queue
      document.getElementById('interruptButton').style.display = 'none';
      geminiMessageElement = null;
      
      // Show visual feedback for interruption
      const messageElement = document.createElement('p');
      messageElement.className = 'interrupted-message';
      messageElement.textContent = 'Response interrupted by user input';
      output.appendChild(messageElement);
      output.scrollTop = output.scrollHeight;
    };

    // Add function call and response handlers
    api.onFunctionCall = (data) => {
      logMessage('Function: ' + data.name);
      logMessage('Parameters: ' + JSON.stringify(data.args, null, 2));
    };

    api.onFunctionResponse = (data) => {
      logMessage('API Response: ' + JSON.stringify(data, null, 2));
    };

    // UI Event Handlers
    async function startRecording() {
      try {
        // If model is speaking, treat this as an interruption
        if (api.isSpeaking) {
          audioStreamer.stop();
          api.isSpeaking = false;
        }

        await audioContext.resume();
        await audioRecorder.start();
        hasShownSpeakingMessage = false;
        currentTurn++;
        geminiMessageElement = null;
        
        audioRecorder.on('data', (base64Data) => {
          if (!hasShownSpeakingMessage) {
            logMessage('You: Audio enabled...');
            hasShownSpeakingMessage = true;
          }
          api.sendAudioChunk(base64Data);
        });

        isRecording = true;
        document.getElementById('micButton').innerHTML = 
          '<span class="material-symbols-outlined">stop</span>';
      } catch (error) {
        console.error('Error starting recording:', error);
        logMessage('Error: ' + error.message);
      }
    }

    function stopRecording() {
      audioRecorder.stop();
      isRecording = false;
      hasShownSpeakingMessage = false;
      document.getElementById('micButton').innerHTML = 
        '<span class="material-symbols-outlined">mic</span>';
      logMessage('You: Audio disabled.');
      
      // Stop video streams
      mediaHandler.stopAll();
      document.getElementById('webcamButton').innerHTML = 
        '<span class="material-symbols-outlined">videocam</span>';
      document.getElementById('screenButton').innerHTML = 
        '<span class="material-symbols-outlined">present_to_all</span>';
      
      api.sendEndMessage();
      api.isSpeaking = false;
    }

    function logMessage(message) {
      const messageElement = document.createElement('p');
      
      // Add specific styling based on message content
      if (message.startsWith('Function:')) {
        messageElement.className = 'function-name';
      } else if (message.startsWith('Parameters:')) {
        messageElement.className = 'function-params';
      } else if (message.startsWith('API Response:')) {
        messageElement.className = 'api-response';
      } else if (message.startsWith('Gemini:')) {
        messageElement.className = 'gemini-message';
      } else if (message.startsWith('You:')) {
        messageElement.className = 'user-message';
      }
      
      messageElement.textContent = message;
      output.appendChild(messageElement);
      output.scrollTop = output.scrollHeight;
    }

    // Add function to send text message
    function sendTextMessage() {
      const textInput = document.getElementById('textInput');
      const text = textInput.value.trim();
      if (!text) return;

      // Clear input
      textInput.value = '';

      // Log user message
      logMessage('You: ' + text);
      geminiMessageElement = null;

      // Send text message
      api.sendTextMessage(text);
    }

    // Set up button click handlers
    document.getElementById('micButton').onclick = () => {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    };

    // Add send button handler
    document.getElementById('sendButton').onclick = sendTextMessage;

    // Add keypress handler for text input
    document.getElementById('textInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendTextMessage();
      }
    });

    // document.getElementById('webcamButton').onclick = async () => {
    //   if (mediaHandler.isWebcamActive) {
    //     mediaHandler.stopAll();
    //     document.getElementById('webcamButton').innerHTML = 
    //       '<span class="material-symbols-outlined">videocam</span>';
    //   } else {
    //     const success = await mediaHandler.startWebcam();
    //     if (success) {
    //       document.getElementById('webcamButton').innerHTML = 
    //         '<span class="material-symbols-outlined">videocam_off</span>';
    //       mediaHandler.startFrameCapture((base64Image) => {
    //         api.sendImage(base64Image);
    //       });
    //     }
    //   }
    // };

    document.getElementById('webcamButton').onclick = async () => {
      const cameraSelect = document.getElementById('cameraSelect');
      const selectedCameraId = cameraSelect.value;
      if (mediaHandler.isWebcamActive) {
        mediaHandler.stopAll();
        document.getElementById('webcamButton').innerHTML = 
          '<span class="material-symbols-outlined">videocam</span>';
      } else {
        console.log("Selected camera ID:", selectedCameraId); 
        const success = await mediaHandler.startWebcam(selectedCameraId);
        if (success) {
          document.getElementById('webcamButton').innerHTML = 
          '<span class="material-symbols-outlined">videocam_off</span>';
          // Only show camera switch button on mobile devices
          if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            document.getElementById('switchCameraButton').classList.remove('hidden');
          // Hide camera selection on mobile device (uses flip camera option instead)
            document.getElementById('cameraSelect').classList.add('hidden')
          }
          mediaHandler.startFrameCapture((base64Image) => {
            api.sendImage(base64Image);
          });
        }
      }
    };

    // Camera Selection
    cameraIconButton.addEventListener('click', async () => {
    if (cameraDropdown.classList.contains('show')) {
      cameraDropdown.classList.remove('show'); //Close if open
      return
    }
    cameraSelect.innerHTML = ""; //clear existing options
    const cameras = await mediaHandler.getCameras();
    if (cameras.length == 0) {
        console.error("No cameras found")
        return
    }

    cameras.forEach((camera) => {
      const option = document.createElement('option');
      option.value = camera.deviceId;
      option.text = camera.label || `Camera`; //Default to "Camera"
      cameraSelect.appendChild(option);
    });

    cameraDropdown.classList.add('show');
    });

    // Add an event listener to close the dropdown when clicking outside
    window.addEventListener('click', (event) => {
      if (!cameraDropdown.contains(event.target) && !cameraIconButton.contains(event.target)) {
        cameraDropdown.classList.remove('show');
      }
    });

    window.addEventListener('DOMContentLoaded', async () => {
      const cameraSelect = document.getElementById('cameraSelect');
      const cameras = await mediaHandler.getCameras();
      cameras.forEach((camera, index) => {
        const option = document.createElement('option');
        option.value = camera.deviceId;
        option.text = camera.label || `Camera ${index + 1}`;
        cameraSelect.appendChild(option);
      });
    });

    

    document.getElementById('screenButton').onclick = async () => {
      if (mediaHandler.isScreenActive) {
        mediaHandler.stopAll();
        document.getElementById('screenButton').innerHTML = 
          '<span class="material-symbols-outlined">present_to_all</span>';
      } else {
        const success = await mediaHandler.startScreenShare();
        if (success) {
          document.getElementById('screenButton').innerHTML = 
            '<span class="material-symbols-outlined">cancel_presentation</span>';
          mediaHandler.startFrameCapture((base64Image) => {
            api.sendImage(base64Image);
          });
        }
      }
    };

    // Add CSS for interrupted message
    // const style = document.createElement('style');
    // style.textContent = `
    //   .interrupted-message {
    //     color: #ff6b6b;
    //     font-style: italic;
    //     margin: 4px 0;
    //     padding: 4px 8px;
    //     border-left: 3px solid #ff6b6b;
    //     background-color: rgba(255, 107, 107, 0.1);
    //     // background-color: rgba(255, 107, 107, 0.1);
    //   }
    // `;
    document.head.appendChild(style);
  </script>
</body>
</html>