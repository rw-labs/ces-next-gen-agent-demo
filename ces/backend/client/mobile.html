<!DOCTYPE html>
<html>
<head>
  <title>Modem Setup Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="styles/mobile-style.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="icon" type="image/x-icon" href="assets/optus-yes.ico">
  <script>
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const forceMobile = urlParams.get('mobile') === 'true';
      const isMobileDevice = forceMobile || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if (isMobileDevice) {
        document.documentElement.classList.add('mobile-device');
      } else {
        document.documentElement.classList.add('desktop-device');
      }
    })();
  </script>
  <style>
    .desktop-device body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f0f0f0;
      margin: 0;
    }

    .desktop-device .mobile-outline {
      width: 410px;
      height: 750px;
      background-color: #cccccc;
      border: 15px solid #c2c1c1f5;
      border-radius: 40px;
      box-shadow: 0 0 20px rgba(5, 5, 5, 0.2);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .mobile-device .mobile-outline {
        width: 100%;
        height: 100dvh;
        background-color: black;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .mobile-device .mobile-screen {
        border-radius: 0px;
    }

    .mobile-screen {
      width: 100%;
      height: 100%;
      background-color: black;
      border-radius: 25px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .header-section {
      position: relative;
      z-index: 10;
      padding: 20px;
      color: white;
      text-align: center;
    }

    .header-section h2 {
        margin-top: 10px;
    }

    .info-text {
        margin-top: 10px;
    }

    .video-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2; /* Above chat */
    }

    .chat-output {
        overflow-y: auto;
        padding: 10px;
        z-index: 1; /* Behind video */
        position: absolute;
        min-height: 0;
        width: 100%;
        box-sizing: border-box;
    }

    .controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }

    #videoPreview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="mobile-outline">
    <div class="mobile-screen">
      <div class="header-section">
        <img src="assets/optus_logo.svg" alt="Optus Modem Assistant" class="center-image">
        <h2>Modem Setup Assistant</h2>
        <div class="info-text">
          <p>I can help you setup your Optus Modem. Use the controls below to talk or share your camera.</p>
        </div>
      </div>
      <!-- <div class="header-section">
        <h1>Modem Setup Assistant</h1>
      </div> -->

      <!-- <div id="functionInfo" class="function-info">
        Waiting for function calls...
      </div> -->

      <div class="video-container">
        <video id="videoPreview" autoplay playsinline class="hidden"></video>
      </div>

      <div id="output" class="chat-output"></div>



      <div class="controls">
        <div id="playButtonContainer" class="centered-button-container">
          <button id="connectButton" class="action-button">
            <span class="material-symbols-outlined">play_arrow</span>
          </button>
        </div>
        <div id="mediaButtonsContainer" class="media-buttons-container hidden">
          <button id="stopButton" class="action-button">
            <span class="material-symbols-outlined">stop</span>
          </button>
          <button id="micButton" class="action-button" disabled>
            <span class="material-symbols-outlined">mic</span>
          </button>
          <!-- <button id="webcamButton" class="action-button" disabled>
            <span class="material-symbols-outlined">videocam</span>
          </button> -->
          <div class="camera-selector">
            <div style="display: flex; gap: 8px;">
              <button id="cameraIconButton" class="action-button">
                <span class="material-symbols-outlined">cameraswitch</span>
              </button>
              <button id="webcamButton" class="action-button">
                <span class="material-symbols-outlined">videocam</span>
              </button>
            </div>
            <div id="cameraDropdown" class="camera-dropdown hidden">
              <select id="cameraSelect">
              </select>
            </div>
          </div>
          <button id="switchCameraButton" class="action-button hidden">
            <span class="material-symbols-outlined">flip_camera_ios</span>
          </button>
          <button id="screenButton" class="action-button hidden" disabled>
            <span class="material-symbols-outlined">present_to_all</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load EventEmitter3 first -->
  <script src="https://cdn.jsdelivr.net/npm/eventemitter3@5.0.1/dist/eventemitter3.umd.min.js"></script>

  <script type="module">
    import { AudioRecorder } from './src/audio/audio-recorder.js';
    import { AudioStreamer } from './src/audio/audio-streamer.js';
    import { MediaHandler } from './src/media/media-handler.js';
    import { GeminiAPI } from './src/api/gemini-api.js';
    import { base64ToArrayBuffer } from './src/utils/utils.js';

    // Check if device is mobile first
    const urlParams = new URLSearchParams(window.location.search);
    const forceMobile = urlParams.get('mobile') === 'true';
    const isMobileDevice = forceMobile || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Initialize components
    const output = document.getElementById('output');
    const audioRecorder = new AudioRecorder();
    const audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
    const audioStreamer = new AudioStreamer(audioContext);
    const mediaHandler = new MediaHandler();
    const api = new GeminiAPI('ws://127.0.0.1:8080/ws'); //only for local development
    // const api = new GeminiAPI('wss://optus-modem-assistant-backend-tm5jum3toa-uc.a.run.app/ws'); //Use for Cloud Run

    // --- DOM Elements ---
    const connectButton = document.getElementById('connectButton');
    const playButtonContainer = document.getElementById('playButtonContainer');
    const mediaButtonsContainer = document.getElementById('mediaButtonsContainer');
    const micButton = document.getElementById('micButton');
    const stopButton = document.getElementById('stopButton');
    let webcamButton = document.getElementById('webcamButton'); // May be replaced for mobile
    const switchCameraButton = document.getElementById('switchCameraButton');
    const screenButton = document.getElementById('screenButton');
    const cameraSelector = document.querySelector('.camera-selector');
    const cameraIconButton = document.getElementById('cameraIconButton');
    const cameraDropdown = document.getElementById('cameraDropdown');
    const cameraSelect = document.getElementById('cameraSelect');

    let isStarted = false;
    let isRecording = false;
    let isMuted = false;
    let currentTurn = 0;
    let lastAudioTurn = -1;

    // --- UI LOGIC ---

    function setupUIForDevice() {
      if (isMobileDevice) {
        cameraIconButton.style.display = 'none';
      } else {
        switchCameraButton.style.display = 'none'; // Hide the mobile flip camera button
      }
      // Assign the single, unified click handler to whichever button is active
      webcamButton.onclick = onWebcamButtonClick;
    }

    function enableMediaControls() {
      micButton.disabled = false;
      webcamButton.disabled = false;
      if (!isMobileDevice) {
        screenButton.disabled = false;
        cameraIconButton.disabled = false;
      }
    }

    function resetUIState() {
      isStarted = false;
      connectButton.disabled = false;
      
      mediaButtonsContainer.classList.add('hidden');
      playButtonContainer.classList.remove('hidden');
      
      micButton.disabled = true;
      micButton.classList.remove('active');
      
      webcamButton.disabled = true;
      webcamButton.classList.remove('active');
      
      screenButton.disabled = true;
      screenButton.classList.remove('active');
      
      switchCameraButton.classList.add('hidden');

      if (!isMobileDevice) {
        cameraIconButton.disabled = false;
        cameraDropdown.classList.add('hidden');
        cameraIconButton.classList.remove('hidden');
      }
    }

    // --- CORE LOGIC ---

    async function startRecording() {
      try {
        if (api.isSpeaking) {
          audioStreamer.stop();
          api.isSpeaking = false;
        }
        await audioContext.resume();
        await audioRecorder.start();
        currentTurn++;
        audioRecorder.on('data', (base64Data) => api.sendAudioChunk(base64Data));
        isRecording = true;
        isMuted = false;
        micButton.classList.add('active');
      } catch (error) {
        console.error('Error starting recording:', error);
        throw error;
      }
    }

    function stopRecording() {
      audioRecorder.stop();
      isRecording = false;
      isMuted = false;
      if (isStarted) {
        api.sendEndMessage();
      }
      api.isSpeaking = false;
    }

    // --- EVENT HANDLERS ---

    connectButton.onclick = async () => {
      try {
        connectButton.disabled = true;
        await audioContext.resume();
        
        const buffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);
        source.start(0);

        await api.ensureConnected();
        
        isStarted = true;
        playButtonContainer.classList.add('hidden');
        mediaButtonsContainer.classList.remove('hidden');
        enableMediaControls();
        await startRecording();
      } catch (error) {
        console.error('Error starting session:', error);
        const existingError = document.querySelector('.connection-error');
        if (!existingError) {
          const errorElement = document.createElement('div');
          errorElement.className = 'connection-error';
          errorElement.textContent = 'Cannot connect to server. Please check if the server is running.';
          document.body.appendChild(errorElement);
        }
        resetUIState();
      }
    };

    stopButton.onclick = async () => {
      stopRecording();
      mediaHandler.stopAll();
      audioStreamer.stop();
      api.isSpeaking = false;
      resetUIState();
      api.sendEndMessage();
    };

    micButton.onclick = () => {
      isMuted = !isMuted;
      if (isMuted) {
        micButton.classList.remove('active');
        audioRecorder.mute();
        audioRecorder.off('data');
      } else {
        micButton.classList.add('active');
        audioRecorder.unmute();
        audioRecorder.on('data', (base64Data) => api.sendAudioChunk(base64Data));
      }
    };

    function logSystemMessage(message) {
      const messageElement = document.createElement('p');
      messageElement.className = 'system-message';
      messageElement.textContent = message;
      output.appendChild(messageElement);
      output.scrollTop = output.scrollHeight;
    }

    async function onWebcamButtonClick() {
        if (mediaHandler.isWebcamActive) {
            mediaHandler.stopAll();
            this.classList.remove('active');
            if (isMobileDevice) {
                switchCameraButton.classList.add('hidden');
            } else {
                cameraIconButton.classList.remove('hidden');
            }
            const message = '[SYSTEM: Video stream ended]';
            api.sendStateUpdate({ "video_active": false });
            // logSystemMessage(message);
        } else {
            if (mediaHandler.isScreenActive) {
                mediaHandler.stopAll();
                screenButton.classList.remove('active');
            }
            
            let success;
            if (isMobileDevice) {
                success = await mediaHandler.startWebcam({ useFrontCamera: false }); // Request rear camera
            } else {
                const deviceId = cameraSelect.value;
                if (!deviceId) {
                    alert("Please select a camera first by clicking the icon next to the video button.");
                    return;
                }
                success = await mediaHandler.startWebcam({ deviceId: deviceId });
            }

            if (success) {
                this.classList.add('active');
                if (isMobileDevice) {
                    switchCameraButton.classList.remove('hidden');
                } else {
                    cameraIconButton.classList.add('hidden');
                    cameraDropdown.classList.add('hidden');
                }
                mediaHandler.startFrameCapture((base64Image) => api.sendImage(base64Image));
                const message = '[SYSTEM: Video stream started]';
                api.sendStateUpdate({ "video_active": true });
                // logSystemMessage(message);
            }
        }
    }

    switchCameraButton.onclick = async () => {
      const endMessage = '[SYSTEM: Video stream ended]';
      api.sendStateUpdate({ "video_active": false });
      // logSystemMessage(endMessage);

      const success = await mediaHandler.switchCamera();

      if (success) {
        const startMessage = '[SYSTEM: Video stream started]';
        api.sendStateUpdate({ "video_active": true });
        // logSystemMessage(startMessage);
      }
    };

    screenButton.onclick = async () => {
      if (mediaHandler.isScreenActive) {
        mediaHandler.stopAll();
        screenButton.classList.remove('active');
      } else {
        if (mediaHandler.isWebcamActive) {
          mediaHandler.stopAll();
          webcamButton.classList.remove('active');
          if(isMobileDevice) switchCameraButton.classList.add('hidden');
          else cameraIconButton.classList.remove('hidden');
        }
        
        const success = await mediaHandler.startScreenShare();
        if (success) {
          screenButton.classList.add('active');
          mediaHandler.startFrameCapture((base64Image) => api.sendImage(base64Image));
        }
      }
    };

    cameraIconButton.addEventListener('click', async (event) => {
        event.stopPropagation();
        if (cameraDropdown.classList.contains('hidden')) {
            const cameras = await mediaHandler.getCameras();
            cameraSelect.innerHTML = ""; 
            if (cameras.length > 0) {
                // Set the size of the select element to show all cameras
                cameraSelect.size = cameras.length;
                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.text = camera.label || `Camera ${cameraSelect.options.length + 1}`;
                    cameraSelect.appendChild(option);
                });
                cameraDropdown.classList.remove('hidden');
            } else {
                console.error("No cameras found.");
            }
        } else {
            cameraDropdown.classList.add('hidden');
        }
    });

    cameraSelect.addEventListener('change', async (event) => {
        cameraDropdown.classList.add('hidden');
        const deviceId = event.target.value;

        if (mediaHandler.isWebcamActive) {
            mediaHandler.stopAll();
            const message = '[SYSTEM: Video stream ended]';
            api.sendStateUpdate({ "video_active": false });
            // logSystemMessage(message);
        }

        if (mediaHandler.isScreenActive) {
            mediaHandler.stopAll();
            screenButton.classList.remove('active');
        }

        const success = await mediaHandler.startWebcam(deviceId);

        if (success) {
            webcamButton.classList.add('active');
            if (!isMobileDevice) {
                cameraIconButton.classList.add('hidden');
            }
            mediaHandler.startFrameCapture((base64Image) => api.sendImage(base64Image));
            const message = '[SYSTEM: Video stream started]';
            api.sendStateUpdate({ "video_active": true });
            // logSystemMessage(message);
        }
    });

    window.addEventListener('click', (event) => {
        if (!cameraDropdown.contains(event.target) && event.target !== cameraIconButton) {
            cameraDropdown.classList.add('hidden');
        }
    });

    // --- API Event Handlers ---
    api.onReady = () => {
      connectButton.disabled = false;
      const existingError = document.querySelector('.connection-error');
      if (existingError) existingError.remove();
    };

    api.onError = (error) => {
      console.error('WebSocket error:', error);
      // Handle different error types with appropriate UI feedback
      resetUIState();
      if (isRecording) stopRecording();
      mediaHandler.stopAll();
    };

    api.onClose = () => {
      if (isStarted) {
        resetUIState();
        if (isRecording) stopRecording();
        mediaHandler.stopAll();
      }
    };

    let turnCompleteTimer = null;
    api.onAudioData = async (audioData) => {
      clearTimeout(turnCompleteTimer);
      turnCompleteTimer = setTimeout(() => {
        console.log('Turn complete timer fired.');
        if (api.onTurnComplete) {
            api.onTurnComplete();
        }
      }, 500);

      try {
        if (!api.isSpeaking || lastAudioTurn !== currentTurn) {
          api.isSpeaking = true;
          lastAudioTurn = currentTurn;

          // --- Automatic Mute on Playback ---
          // Mute the microphone when the agent starts speaking to prevent
          // feedback loops or unwanted interruptions.
          audioRecorder.mute();
          audioRecorder.off('data');
        }
        const arrayBuffer = base64ToArrayBuffer(audioData);
        audioStreamer.addPCM16(new Uint8Array(arrayBuffer));
        audioStreamer.resume();
      } catch (error) {
        console.error('Error playing audio:', error);
      }
    };

    api.onTurnComplete = () => {
      if (turnCompleteTimer) {
        clearTimeout(turnCompleteTimer);
        turnCompleteTimer = null;
      }
      console.log('onTurnComplete called. Resetting isSpeaking and incrementing turn.');
      api.isSpeaking = false;
      audioStreamer.complete();
      currentTurn++;
    };

    audioStreamer.onComplete = () => {
      // --- Automatic Unmute after Playback ---
      // Unmute the microphone, but only if the user hasn't manually muted it.
      if (!isMuted) {
        audioRecorder.unmute();
        audioRecorder.on('data', (base64Data) => api.sendAudioChunk(base64Data));
      }
    };

    api.onTextContent = (text) => {
      if (text.trim()) {
        const messageElement = document.createElement('p');
        messageElement.className = 'gemini-message';
        messageElement.textContent = 'Gemini: ' + text;
        output.appendChild(messageElement);
        output.scrollTop = output.scrollHeight;
      }
    };

    api.onInterrupted = () => {
      api.isSpeaking = false;
      audioStreamer.stop();
      const messageElement = document.createElement('p');
      messageElement.className = 'interrupted-message';
      messageElement.textContent = 'Response interrupted by user input';
      // output.appendChild(messageElement);
      output.scrollTop = output.scrollHeight;
    };

    // --- INITIALIZATION ---
    mediaHandler.initialize(document.getElementById('videoPreview'));
    setupUIForDevice();

    

  

  

  

    function adjustLayout() {
      const mobileScreen = document.querySelector('.mobile-screen');
      if (!mobileScreen) return;

      const header = mobileScreen.querySelector('.header-section');
      const controls = mobileScreen.querySelector('.controls');
      const chatOutput = mobileScreen.querySelector('.chat-output');
      const videoContainer = mobileScreen.querySelector('.video-container');

      const headerHeight = header.offsetHeight;
      const controlsHeight = controls.offsetHeight;
      const screenHeight = mobileScreen.offsetHeight;

      const availableHeight = screenHeight - headerHeight - controlsHeight;

      chatOutput.style.height = `${availableHeight}px`;
      chatOutput.style.top = `${headerHeight}px`;
      videoContainer.style.height = `${availableHeight}px`;
      videoContainer.style.top = `${headerHeight}px`;
    }

    window.addEventListener('load', adjustLayout);
    window.addEventListener('resize', adjustLayout);


  </script>
</body>
</html>